{
  "hash": "7f66269ac432ca89ac3adee281c4143f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"8 倾向得分匹配\"\nformat: html\neditor: visual\n---\n\n## 本章导读\n\n倾向得分匹配是处理观察性数据中由**可观测混杂因素**导致的选择偏差的核心方法。当个体是否接受某项处理并非随机分配，而是依赖于可观测的特征变量时，处理组和对照组在这些特征上的不平衡分布会导致简单的均值比较产生偏误。本章将系统介绍倾向得分匹配的基本原理，该方法通过为每个处理组个体寻找特征相似的对照组个体，构造\"近似可比\"的比较组，从而在观察性研究中模拟随机实验的平衡性特征。我们将详细讲解倾向得分的估计、匹配方法的实施、匹配质量的诊断以及前沿的扩展方法。\n\n## 8.1 选择偏差问题与匹配方法的引入\n\n### 8.1.1 观察性研究中的选择偏差：从反事实框架看比较组的不可比性\n\n在观察性研究中，个体是否接受处理通常不是随机的，而是基于可观测（有时是不可观测）的特征进行自我选择或被选择。这导致处理组和对照组在潜在结果分布上存在系统性差异，即**选择偏差**。\n\n**反事实框架下的选择偏差**： 考虑处理效应$ATT = E[Y_i(1) - Y_i(0) | D_i=1]$，我们能够观测到的是： $$\nE[Y_i | D_i=1] - E[Y_i | D_i=0] = ATT + \\underbrace{E[Y_i(0) | D_i=1] - E[Y_i(0) | D_i=0]}_{\\text{选择偏差}}\n$$\n\n如果选择偏差不为零，简单的组间均值比较不能无偏地估计处理效应。选择偏差的根源在于处理组和对照组在未处理状态下的潜在结果均值不同。\n\n**可观测选择偏差**： 当选择机制完全由可观测特征$X_i$决定时，即满足**条件独立性假设**： $$\n(Y_i(1), Y_i(0)) \\perp D_i | X_i\n$$\n\n在这种情况下，选择偏差完全由可观测特征$X_i$的分布差异导致，可以通过统计方法进行调整。\n\n### 8.1.2 匹配方法的基本逻辑：构造平衡可观测特征的比较组\n\n匹配方法的核心思想是：对于每个处理组个体，从对照组中寻找一个或多个具有相似可观测特征的个体，用这些匹配个体的结果作为该处理组个体的反事实结果的近似。\n\n**精确匹配**： 最理想的情况是精确匹配，即对于每个处理组个体，找到在$X_i$上完全相同的对照组个体。但这种方法在实际中往往不可行，因为： 1. $X_i$通常是连续变量或多维变量，精确匹配很难实现 2. 即使找到精确匹配，样本量会急剧减少\n\n**近似匹配**： 在实践中，我们进行近似匹配，即寻找$X_i$上\"相似\"的个体。衡量相似性的方法包括： 1. 马氏距离：$(X_i - X_j)'\\Sigma^{-1}(X_i - X_j)$ 2. 欧氏距离：$\\|X_i - X_j\\|$ 3. 倾向得分距离：$|p(X_i) - p(X_j)|$\n\n### 8.1.3 维度诅咒与倾向得分的提出\n\n当可观测特征$X_i$的维度较高时，直接基于$X_i$进行匹配会遇到**维度诅咒**问题：随着维度增加，找到足够相似的匹配对象变得越来越困难。\n\n**Rosenbaum和Rubin（1983）的突破**： Rosenbaum和Rubin证明，如果条件独立性假设成立，那么匹配可以基于一维的**倾向得分**$p(X_i) = P(D_i=1|X_i)$进行，而无需基于高维的$X_i$。这是因为倾向得分具有以下重要性质： 1. **平衡性**：在给定$p(X_i)$的条件下，$D_i$与$X_i$独立 2. **可忽略性**：在给定$p(X_i)$的条件下，$(Y_i(1), Y_i(0))$与$D_i$独立\n\n因此，基于倾向得分的匹配可以达到与基于$X_i$的匹配相同的平衡效果，同时避免了维度诅咒问题。\n\n## 8.2 倾向得分的定义、性质与估计\n\n### 8.2.1 倾向得分的定义：条件处理概率\n\n倾向得分定义为给定可观测特征$X_i$的条件下，个体接受处理的概率： $$\np(X_i) = P(D_i=1|X_i) = E[D_i|X_i]\n$$\n\n倾向得分是一个介于0和1之间的数值，反映了在观察到$X_i$的情况下，个体接受处理的可能性。\n\n**倾向得分的解释**： - 倾向得分接近1：具有特征$X_i$的个体几乎肯定接受处理 - 倾向得分接近0：具有特征$X_i$的个体几乎肯定不接受处理 - 倾向得分在中间范围：接受处理与否有一定不确定性\n\n### 8.2.2 平衡得分性质与可忽略性假设\n\n**平衡得分**： 平衡得分$b(X)$是$X$的任意函数，使得在给定$b(X)$的条件下，处理分配$D$与特征$X$独立： $$\nD \\perp X | b(X)\n$$\n\n**定理（Rosenbaum和Rubin，1983）**： 倾向得分$p(X)$是一个平衡得分。事实上，它是最粗糙的平衡得分（即包含信息最少但足以达到平衡）。\n\n**可忽略性假设**： 如果条件独立性假设在$X$条件下成立，那么在任意平衡得分$b(X)$条件下也成立： $$\n(Y(1), Y(0)) \\perp D | X \\Rightarrow (Y(1), Y(0)) \\perp D | b(X)\n$$\n\n特别地，在倾向得分$p(X)$条件下： $$\n(Y(1), Y(0)) \\perp D | p(X)\n$$\n\n这意味着，如果两组个体具有相同的倾向得分，那么他们的处理分配可以视为近似随机的，他们的潜在结果分布应该相似。\n\n### 8.2.3 共同支持域条件\n\n共同支持域是指处理组和对照组的倾向得分分布有重叠的区域。形式化地，共同支持域定义为： $$\nS = \\{p: 0 < f(p|D=1) \\text{ 且 } 0 < f(p|D=0)\\}\n$$ 其中$f(p|D=d)$是倾向得分在组$d$中的密度函数。\n\n**实际操作中的共同支持域**： 我们通常要求： $$\n0 < p(X_i) < 1 \\quad \\text{对于所有} X_i\n$$\n\n在实践中，我们检查并确保： 1. 处理组和对照组的倾向得分分布有显著重叠 2. 没有个体具有极端倾向得分（如接近0或1）\n\n**样本修剪**： 如果存在极端倾向得分的个体，通常的做法是进行样本修剪，即删除倾向得分超出共同范围的个体。虽然这减少了样本量，但可以提高匹配质量，减少外推偏差。\n\n### 8.2.4 倾向得分的估计：Logit与Probit模型\n\n倾向得分通常通过参数模型估计，最常用的是Logit和Probit模型。\n\n**Logit模型**： $$\np(X_i) = \\frac{\\exp(X_i'\\beta)}{1+\\exp(X_i'\\beta)}\n$$ 其中$\\beta$是系数向量，通过最大似然估计得到。\n\n**Probit模型**： $$\np(X_i) = \\Phi(X_i'\\beta)\n$$ 其中$\\Phi(\\cdot)$是标准正态累积分布函数。\n\n**模型选择与设定**： 1. 应该包含所有同时影响处理状态和结果变量的协变量 2. 可以考虑高阶项（平方项、交互项）以改善平衡性 3. 不应包含仅影响结果但不影响处理状态的变量（这不会改善平衡性，但可能增加方差） 4. 不应包含仅影响处理状态但不影响结果的变量（这可能导致\"坏控制\"问题）\n\n**模型诊断**： 1. 伪R²：衡量模型拟合优度，但高伪R²不一定表示好的平衡性 2. 预测概率的分布：检查是否有很多接近0或1的预测值 3. Hosmer-Lemeshow检验：检验预测概率与实际处理比例的一致性\n\n## 8.3 倾向得分匹配的实施步骤\n\n### 8.3.1 第一步：估计倾向得分与检验重叠性\n\n**估计倾向得分**： 使用Logit或Probit模型估计每个个体的倾向得分$\\hat{p}(X_i)$。\n\n**检验重叠性**： 1. 绘制处理组和对照组的倾向得分分布图（直方图或核密度图） 2. 计算倾向得分的描述性统计量（最小值、最大值、分位数） 3. 确定共同支持域：通常删除倾向得分小于对照组最大值且大于处理组最小值的个体，或删除分布两端一定比例（如1%或5%）的个体\n\n**重叠性图形示例**：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# R代码示例：绘制倾向得分分布图\nlibrary(ggplot2)\nggplot(data, aes(x=pscore, fill=treat)) +\n  geom_density(alpha=0.5) +\n  labs(x=\"Propensity Score\", y=\"Density\", fill=\"Treatment\")\n```\n:::\n\n\n### 8.3.2 第二步：选择匹配方法\n\n常用的匹配方法包括：\n\n**最近邻匹配**： 为每个处理组个体寻找倾向得分最接近的一个或多个对照组个体。 - 一对一匹配：每个处理组个体匹配一个最接近的对照组个体 - 一对多匹配：每个处理组个体匹配k个最接近的对照组个体 - 有放回 vs. 无放回：有放回允许对照组个体被多次匹配，通常能提高匹配质量\n\n**卡尺匹配**： 要求匹配个体的倾向得分差异不超过预设的阈值（卡尺）。卡尺通常设定为倾向得分标准差的0.2-0.25倍。\n\n**半径匹配**： 为每个处理组个体匹配所有在卡尺内的对照组个体，这些对照组个体获得相等的权重。\n\n**核匹配**： 使用所有对照组个体进行匹配，但根据倾向得分差异给予不同权重。权重由核函数$K(\\cdot)$决定： $$\nw_{ij} = \\frac{K\\left(\\frac{\\hat{p}(X_j) - \\hat{p}(X_i)}{h}\\right)}{\\sum_{k:D_k=0} K\\left(\\frac{\\hat{p}(X_k) - \\hat{p}(X_i)}{h}\\right)}\n$$ 其中$h$是带宽参数。\n\n**匹配方法的选择考量**： 1. 偏差-方差权衡：更严格的匹配（如一对一）可能减少偏差但增加方差 2. 计算复杂性：核匹配通常计算量更大 3. 样本利用率：半径匹配和核匹配利用了更多对照组信息\n\n### 8.3.3 第三步：匹配后样本平衡性诊断\n\n匹配后需要检验处理组和匹配后的对照组在可观测特征上是否平衡。\n\n**标准化差异**： 对于每个协变量$X_k$，计算标准化差异： $$\nSD_k = \\frac{\\bar{X}_{k,treated} - \\bar{X}_{k,matched\\_control}}{\\sqrt{(s_{k,treated}^2 + s_{k,matched\\_control}^2)/2}}\n$$ 其中$\\bar{X}$是均值，$s^2$是方差。\n\n经验上，匹配后所有协变量的标准化差异应小于0.1（理想情况下小于0.05）。\n\n**方差比**： 对于每个协变量$X_k$，计算处理组和匹配对照组的方差比： $$\nVR_k = \\frac{s_{k,treated}^2}{s_{k,matched\\_control}^2}\n$$ 匹配后，方差比应接近1（如0.8-1.25之间）。\n\n**t检验**： 对每个协变量进行两组均值差异的t检验。匹配后，这些检验应不再显著（p值\\>0.05）。\n\n### 8.3.4 第四步：估计处理效应与统计推断\n\n**处理效应估计**： 匹配后，处理效应可以通过比较处理组和匹配对照组的结果均值来估计。对于一对一匹配： $$\n\\hat{\\tau}_{ATT} = \\frac{1}{N_1} \\sum_{i:D_i=1} \\left[Y_i - \\frac{1}{M}\\sum_{j\\in J_M(i)} Y_j\\right]\n$$ 其中$J_M(i)$是处理组个体$i$的$M$个匹配的对照组个体集合。\n\n对于核匹配： $$\n\\hat{\\tau}_{ATT} = \\frac{1}{N_1} \\sum_{i:D_i=1} \\left[Y_i - \\frac{\\sum_{j:D_j=0} w_{ij} Y_j}{\\sum_{j:D_j=0} w_{ij}}\\right]\n$$\n\n**统计推断**： 由于倾向得分是估计得到的，且匹配过程引入了相关性，传统的标准误计算可能不正确。常用的方法包括： 1. **自助法**：对原始样本进行重复抽样，每次重新估计倾向得分并进行匹配 2. **Abadie-Imbens标准误**：考虑了匹配不确定性的解析标准误 3. **稳健标准误公式**：基于匹配后样本计算的稳健标准误\n\n**自助法步骤**： 1. 从原始样本中有放回地抽取一个自助样本 2. 在自助样本中重新估计倾向得分 3. 基于新的倾向得分重新进行匹配 4. 计算处理效应估计值 5. 重复B次（如500次），得到处理效应的自助分布 6. 基于自助分布计算标准误和置信区间\n\n## 8.4 匹配质量的诊断与敏感性分析\n\n### 8.4.1 平衡性检验：标准化差异、t检验与方差比\n\n**平衡性检验表**： 研究报告应包含匹配前后的平衡性检验表，展示： 1. 每个协变量的处理组和对照组均值 2. 标准化差异（匹配前后） 3. 方差比（匹配前后） 4. t检验的p值（匹配前后）\n\n**可视化平衡性改进**： 可以绘制匹配前后标准化差异的图形，直观展示平衡性的改善。\n\n**经验准则**： - 所有协变量的匹配后标准化差异应\\<0.1 - 至少90%的协变量的标准化差异应\\<0.05 - 方差比应在0.8-1.25之间 - t检验的p值应\\>0.05\n\n### 8.4.2 倾向得分分布重叠图\n\n**分布重叠图**： 绘制处理组和对照组（匹配前后）的倾向得分分布图，直观展示： 1. 匹配前两组分布的差异 2. 匹配后两组分布的相似性 3. 共同支持域的范围\n\n**分位数-分位数图**： 绘制处理组和对照组倾向得分分位数的Q-Q图，如果点在45度线附近，说明两组分布相似。\n\n### 8.4.3 敏感性分析：评估未观测混杂因素的影响\n\n倾向得分匹配只能控制可观测的混杂因素。如果存在未观测的混杂因素，估计结果可能仍有偏误。敏感性分析用于评估这种可能性。\n\n**Rosenbaum界限方法**： 该方法评估需要多大的未观测混杂因素才能推翻研究结论。设$\\Gamma$表示未观测混杂因素的最大影响，定义为两个具有相同可观测特征的个体接受处理概率的最大比值。\n\n**敏感性分析步骤**： 1. 对于不同的$\\Gamma$值（如1.5, 2.0, 2.5），计算处理效应的置信区间 2. 确定使结论变得不显著的$\\Gamma$值 3. 评估这样的$\\Gamma$值是否合理\n\n**经验解释**： 如果较小的$\\Gamma$（如$\\Gamma=1.5$）就能使结论变得不显著，说明结果对未观测混杂因素敏感。如果较大的$\\Gamma$（如$\\Gamma=3.0$）才能使结论不显著，说明结果相对稳健。\n\n## 8.5 倾向得分方法的扩展\n\n### 8.5.1 逆概率加权法\n\n逆概率加权法不进行匹配，而是通过加权使处理组和对照组在特征分布上平衡。\n\n**ATE的IPW估计量**： $$\n\\hat{\\tau}_{ATE}^{IPW} = \\frac{1}{N}\\sum_{i=1}^N \\left[\\frac{D_i Y_i}{\\hat{p}(X_i)} - \\frac{(1-D_i)Y_i}{1-\\hat{p}(X_i)}\\right]\n$$\n\n**ATT的IPW估计量**： $$\n\\hat{\\tau}_{ATT}^{IPW} = \\frac{1}{\\sum_{i=1}^N D_i} \\sum_{i=1}^N D_i Y_i - \\frac{1}{\\sum_{i=1}^N D_i} \\sum_{i=1}^N \\frac{D_i \\hat{p}(X_i)(1-D_i)Y_i}{1-\\hat{p}(X_i)}\n$$\n\n**优点与缺点**： - 优点：使用了所有样本，比匹配更有效率 - 缺点：对倾向得分模型设定敏感，特别是当倾向得分接近0或1时，权重会变得很大，导致估计不稳定\n\n### 8.5.2 双重稳健估计\n\n双重稳健估计结合了倾向得分加权和结果回归，只要其中一个模型正确设定，就能得到一致估计。\n\n**DR估计量**： $$\n\\hat{\\tau}_{DR} = \\frac{1}{N}\\sum_{i=1}^N \\left[\\frac{D_i(Y_i - \\hat{m}_1(X_i))}{\\hat{p}(X_i)} + \\hat{m}_1(X_i)\\right] - \\frac{1}{N}\\sum_{i=1}^N \\left[\\frac{(1-D_i)(Y_i - \\hat{m}_0(X_i))}{1-\\hat{p}(X_i)} + \\hat{m}_0(X_i)\\right]\n$$ 其中$\\hat{m}_1(X_i) = E[Y_i|D_i=1, X_i]$和$\\hat{m}_0(X_i) = E[Y_i|D_i=0, X_i]$是通过回归模型估计的。\n\n**优点**： 对模型误设更稳健，且通常比单独的匹配或IPW更有效。\n\n### 8.5.3 广义倾向得分（处理变量连续或多值）\n\n当处理变量是连续或多值时，可以使用广义倾向得分方法。\n\n**连续处理情况**： 对于连续处理$T_i$，广义倾向得分定义为处理变量的条件密度： $$\nr(t, X_i) = f_{T|X}(t|X_i)\n$$\n\n**剂量反应函数**： 剂量反应函数$\\mu(t) = E[Y_i(t)]$可以通过逆概率加权估计： $$\n\\hat{\\mu}(t) = \\frac{1}{N}\\sum_{i=1}^N \\frac{K_h(T_i - t)Y_i}{r(t, X_i)}\n$$ 其中$K_h(\\cdot)$是核函数，$h$是带宽。\n\n### 8.5.4 边际结构模型简介\n\n边际结构模型通过逆概率加权估计边际处理效应，特别适用于处理随时间变化的情况。\n\n**时变处理**： 设$T$个时期的处理序列为$\\bar{D} = (D_1, ..., D_T)$，协变量序列为$\\bar{X} = (X_1, ..., X_T)$。每个时期的权重为： $$\nw_i = \\prod_{t=1}^T \\frac{1}{P(D_t=d_t|\\bar{D}_{t-1}=\\bar{d}_{t-1}, \\bar{X}_t=\\bar{x}_t)}\n$$\n\n**MSM模型**： 估计边际结构模型： $$\nE[Y(\\bar{d})] = \\beta_0 + \\beta_1 \\text{cum}(\\bar{d})\n$$ 其中$\\text{cum}(\\bar{d})$是累计处理量。\n\n**优点**： 能处理时变混杂因素，但需要正确设定每个时期的倾向得分模型。\n\n## 8.6 应用实例与操作实践\n\n### 8.6.1 经典案例：劳动力市场培训项目评估\n\n### 8.6.2 软件操作：Stata (`psmatch2`, `teffects`) 与 R (`MatchIt`, `WeightIt`)\n\n### 8.6.3 研究报告规范与常见误区\n\n## 本章总结\n\n倾向得分匹配通过模拟随机实验的逻辑，在观察性研究中为处理组个体寻找特征相似的控制组个体，从而减少可观测混杂因素的影响。本章系统介绍了从倾向得分估计、匹配方法选择、平衡性检验到因果效应估计的完整流程。\n\n需要强调的是，PSM只能控制**可观测**的混杂变量，其有效性依赖于**强可忽略性假设**。对于不可观测的混杂因素，PSM无法解决，需要借助其他方法（如工具变量、固定效应模型等）或进行敏感性分析。\n\n成功的PSM应用不仅依赖于恰当的统计方法，更取决于： 1. 对研究问题的深入理解 2. 对相关混杂因素的全面测量 3. 对匹配结果的严谨诊断检验 4. 对模型假设和局限性的清晰认识\n\n倾向得分方法已发展出多种扩展形式，包括逆概率加权、双重稳健估计、广义倾向得分和边际结构模型，这些方法丰富了观察性研究中因果推断的工具箱。在实际应用中，研究者应根据具体研究问题和数据特征选择合适的方法，并通过敏感性分析评估估计结果的稳健性。\n\n最后，无论使用哪种基于倾向得分的方法，都必须牢记：这些方法只能解决由可观测变量导致的选择偏差。对于因果推断，没有任何统计方法可以完全替代良好的研究设计和严谨的理论思考。",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}