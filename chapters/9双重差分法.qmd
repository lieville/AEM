---
title: "9 双重差分法"
format: html
editor: visual
---

# 第9章 双重差分法

## 本章导读

双重差分法是现代计量经济学中进行政策评估和因果推断的核心方法之一。当研究者无法进行随机实验，但可以观察到政策实施前后的变化时，DID通过比较处理组和对照组在政策实施前后的差异变化，来识别政策的因果效应。本章将系统介绍双重差分法的基本思想、核心假设、模型设定、统计推断方法以及前沿扩展。通过学习，读者将掌握使用DID进行政策评估的完整框架，理解其应用前提与常见陷阱，为实际研究提供方法基础。

## 9.1 双重差分法的基本思想与模型设定

### 9.1.1 双重差分法的直观逻辑与基本框架

双重差分法（Difference-in-Differences, DID）是一种准实验设计方法，用于评估政策或处理的效果。其基本思想是通过比较处理组和对照组在政策实施前后结果变量的变化差异，来识别政策的净效应。

设$Y_{it}$为个体$i$在时期$t$的结果变量，$D_{it}$为处理状态变量（$D_{it}=1$表示接受处理，$D_{it}=0$表示未接受处理）。假设政策在时期$t^*$实施，且实施后处理组持续接受处理。

**双重差分估计量**的直观计算为：

$$
\hat{\tau}_{DID} = (\bar{Y}_{1,post} - \bar{Y}_{1,pre}) - (\bar{Y}_{0,post} - \bar{Y}_{0,pre})
$$

其中：
- $\bar{Y}_{1,post}$：处理组在政策后的平均结果
- $\bar{Y}_{1,pre}$：处理组在政策前的平均结果
- $\bar{Y}_{0,post}$：对照组在政策后的平均结果
- $\bar{Y}_{0,pre}$：对照组在政策前的平均结果

### 9.1.2 经典双重差分模型（Two-way Fixed Effects Model）

经典DID模型通常表示为双向固定效应模型：

$$
Y_{it} = \alpha + \beta D_{it} + \gamma_i + \lambda_t + \epsilon_{it}
$$

其中：
- $\alpha$：截距项
- $D_{it}$：处理状态变量（处理组在政策实施后取1，否则取0）
- $\beta$：核心参数，表示处理效应
- $\gamma_i$：个体固定效应，控制个体不随时间变化的特征
- $\lambda_t$：时间固定效应，控制时间趋势和共同冲击
- $\epsilon_{it}$：随机误差项

更一般地，对于平衡面板数据，DID模型可以写为：

$$
Y_{it} = \beta_0 + \beta_1 Treat_i \times Post_t + \beta_2 Treat_i + \beta_3 Post_t + \epsilon_{it}
$$

其中：
- $Treat_i$：个体是否属于处理组的虚拟变量（$Treat_i=1$表示处理组，$Treat_i=0$表示对照组）
- $Post_t$：时间是否在政策后的虚拟变量（$Post_t=1$表示政策后，$Post_t=0$表示政策前）

此时，处理效应$\beta_1$即为双重差分估计量。

### 9.1.3 处理效应的图形化展示与直观理解

DID的直观性部分来自于其图形化展示。一个典型的DID图形包括：
1. 横轴：时间（政策实施时点标记）
2. 纵轴：结果变量的均值
3. 两条线：分别代表处理组和对照组的时间趋势

在平行趋势假设下，政策实施前两条线应基本平行，政策实施后处理组的线应出现"跳跃"或趋势变化，而对照组的线应继续原有趋势。

图形化展示不仅有助于直观理解DID的逻辑，也是检验平行趋势假设的重要工具。

### 9.1.4 DID与简单前后比较、截面比较的差异

DID方法相对于简单方法的优势在于：

**相对于简单前后比较**：
- 简单前后比较：$\hat{\tau}_{pre-post} = \bar{Y}_{1,post} - \bar{Y}_{1,pre}$
- 问题：无法区分政策效应与其他时间趋势（如宏观经济变化、技术进步等）

**相对于截面比较**：
- 简单截面比较：$\hat{\tau}_{cross-section} = \bar{Y}_{1,post} - \bar{Y}_{0,post}$
- 问题：无法控制处理组和对照组的事前差异

DID通过双重差分，既控制了时间趋势，也控制了两组的事前差异，从而更准确地识别政策效应。

## 9.2 平行趋势假设：DID的识别基石

### 9.2.1 平行趋势假设的核心内涵与经济学解释

平行趋势假设是DID方法成立的**核心识别假设**。其正式表述为：

在缺乏政策干预的情况下，处理组和对照组的潜在结果随时间变化的趋势相同。即：

$$
E[Y_{it}(0) | Treat_i=1, t] - E[Y_{it}(0) | Treat_i=1, t-1] = E[Y_{it}(0) | Treat_i=0, t] - E[Y_{it}(0) | Treat_i=0, t-1]
$$

其中$Y_{it}(0)$表示未接受处理时的潜在结果。

**经济学解释**：
平行趋势假设要求，如果没有政策干预，处理组和对照组的结果变量会按照相同的趋势演变。这意味着两组除了是否接受政策干预外，在其他所有影响结果变量的因素上具有相似的时间趋势。

平行趋势假设的合理性取决于：
1. 对照组的选取是否恰当
2. 是否有未观测到的时变混杂因素同时影响处理状态和结果变量

### 9.2.2 平行趋势的检验方法

#### 事件研究图（Event Study Plot）
事件研究图是最直观的平行趋势检验方法。通过估计以下模型：

$$
Y_{it} = \alpha_i + \lambda_t + \sum_{k=-K}^{-1} \beta_k \cdot Treat_i \times 1(t = \text{政策前}k期) + \sum_{k=0}^{L} \beta_k \cdot Treat_i \times 1(t = \text{政策后}k期) + \epsilon_{it}
$$

其中，将政策实施前的$K$期和政策实施后的$L$期分别与处理组虚拟变量交互。

检验方法：
1. 政策前的交互项系数$\beta_k$（$k<0$）应统计上不显著（与0无差异）
2. 政策后的交互项系数$\beta_k$（$k\geq0$）应显示政策效应

图形上，政策前的点应在0附近随机波动，政策后的点应显示政策效应。

#### 动态效应模型
动态效应模型是事件研究图的参数化形式：

$$
Y_{it} = \alpha_i + \lambda_t + \sum_{m=-M}^{M} \beta_m \cdot Treat_i \times Post_{t,m} + \epsilon_{it}
$$

其中$Post_{t,m}$是表示与政策时点相对距离的虚拟变量。

### 9.2.3 平行趋势不满足时的后果与应对策略

**平行趋势不满足的后果**：
如果平行趋势假设不成立，DID估计量将存在偏差：

$$
\hat{\tau}_{DID} \xrightarrow{p} \tau + \text{趋势差异}
$$

其中"趋势差异"是处理组和对照组在无政策情况下的趋势差异。

**应对策略**：
1. **调整对照组**：寻找更合适的对照组
2. **合成控制法**：构造合成的对照组
3. **匹配DID**：先进行匹配，再进行DID分析
4. **三重差分法**：引入第三个差分维度
5. **控制时间趋势**：加入组别特定的时间趋势

### 9.2.4 替代性假设与敏感性分析

当平行趋势假设难以验证时，可以考虑以下替代方法：

**共同趋势假设**：
要求处理组和对照组的趋势差异是固定的，不随时间变化。这比平行趋势假设稍弱。

**敏感性分析**：
通过检验DID估计结果对平行趋势假设的敏感性，评估结论的稳健性。常见方法包括：
1. 安慰剂检验：将政策时点提前，检验"伪政策"效应
2. 置换检验：随机分配处理状态，检验估计效应分布
3. 控制更多时变协变量

## 9.3 双重差分法的估计、推断与稳健标准误

### 9.3.1 DID模型的参数估计与处理效应解释

DID模型通常通过最小二乘法（OLS）进行估计。对于双向固定效应模型：

$$
Y_{it} = \beta D_{it} + \gamma_i + \lambda_t + \epsilon_{it}
$$

可以通过以下方法估计：
1. **LSDV法**：加入个体和时间虚拟变量
2. **组内估计法**：先对个体和时间去均值，再回归
3. **Stata命令**：`xtreg y d, fe` 或 `reghdfe y d, absorb(i t)`

**处理效应的解释**：
- $\hat{\beta}$表示平均处理效应（ATE）
- 如果处理效应异质，$\hat{\beta}$表示处理组平均处理效应（ATT）
- 动态模型中，$\hat{\beta}_m$表示政策实施后第$m$期的处理效应

### 9.3.2 聚类稳健标准误：为何在DID中至关重要

在DID分析中，误差项通常存在：
1. **组内自相关**：同一组别内不同时期的误差相关
2. **组间异方差**：不同组别的误差方差不同

这些问题会导致传统标准误低估真实不确定性，使得统计推断失效。

**聚类稳健标准误**：
将标准误聚类在组别层面（如个体层面或更高层级），可以解决组内自相关问题。聚类稳健方差估计量为：

$$
\widehat{Var}_{cluster}(\hat{\beta}) = (X'X)^{-1} \left( \sum_{g=1}^{G} X_g' \hat{\epsilon}_g \hat{\epsilon}_g' X_g \right) (X'X)^{-1}
$$

其中$g$表示聚类，$G$为聚类总数。

**聚类层级选择**：
1. 个体层面聚类：处理组内自相关问题
2. 更高层级聚类：如县级、省级，处理更广泛的相关性
3. 双重聚类：同时考虑时间和个体维度

**经验法则**：
- 至少聚类在处理组层面
- 当聚类数量较少时（如<50），使用小样本调整（如Wild bootstrap）

### 9.3.3 Conley估计、bootstrap等替代推断方法

当聚类数量较少或存在更复杂的误差结构时，可以考虑以下方法：

**Conley标准误**：
处理空间自相关的标准误估计方法，适用于地理相邻单元可能存在相关性的情况。

**Bootstrap方法**：
通过重复抽样计算标准误，特别适用于小样本情况：
1. 对残差进行重抽样（残差bootstrap）
2. 对聚类进行重抽样（聚类bootstrap）
3. Wild bootstrap：特别适用于小样本和异方差情况

**排列检验**：
通过随机置换处理状态，构建处理效应的经验分布，进行非参数推断。

### 9.3.4 处理组样本量较小时的统计推断问题

当处理组数量较少时（如政策只影响少数几个地区），传统推断方法可能失效：

**问题**：
1. 聚类稳健标准误可能严重低估
2. 中心极限定理可能不适用
3. 统计检验势较低

**解决方案**：
1. **Wild cluster bootstrap**：特别适用于少量聚类的情况
2. **随机化推断**：基于随机分配处理的假设进行推断
3. **贝叶斯方法**：引入先验信息
4. **合成控制法**：特别适用于单一处理组的情况

## 9.4 双重差分法的扩展模型

### 9.4.1 多期DID与异质性处理效应（交错DID）问题

在实际应用中，政策往往在不同时间点对不同个体实施，形成交错DID设计。

**交错DID模型**：
设个体$i$在时期$G_i$首次接受处理，之后持续处于处理状态。传统双向固定效应模型为：

$$
Y_{it} = \beta D_{it} + \gamma_i + \lambda_t + \epsilon_{it}
$$

其中$D_{it} = 1(t \geq G_i)$。

**异质性处理效应问题**：
近期研究（如Goodman-Bacon，2021；Sun & Abraham，2021）发现，当处理效应异质时（不同队列、不同时期效应不同），传统双向固定效应估计量可能是有偏的，它是不同"2×2 DID"比较的加权平均。

### 9.4.2 异质性处理效应的识别

#### Sun & Abraham（2021）方法
通过估计事件研究模型，使用从未接受处理的组作为对照组：

$$
Y_{it} = \gamma_i + \lambda_t + \sum_{g} \sum_{e \neq -1} \beta_{ge} \cdot 1(G_i=g) \cdot 1(E_{it}=e) + \epsilon_{it}
$$

其中$E_{it}=t-G_i$表示相对事件时间，以政策前一期（$e=-1$）为基准。

#### Callaway & Sant'Anna（2021）方法
基于反事实框架，使用从未接受处理的组或尚未接受处理的组作为对照组，估计组别-时期平均处理效应：

$$
ATT(g,t) = E[Y_t - Y_{g-1} | G=g] - E[Y_t - Y_{g-1} | G>t]
$$

#### Borusyak et al.（2021）方法
使用插补法：先用未处理样本估计反事实结果，再计算处理效应。

### 9.4.3 连续型处理与强度DID

当处理强度在不同个体或不同时间不同时，可以使用强度DID：

**模型设定**：
$$
Y_{it} = \beta_0 + \beta_1 Intensity_i \times Post_t + \beta_2 Intensity_i + \beta_3 Post_t + \epsilon_{it}
$$

其中$Intensity_i$表示处理强度。

**识别假设**：
除了平行趋势，还需要满足处理强度的外生性假设：处理强度与潜在结果变化无关。

### 9.4.4 三重差分法：排除混杂政策的影响

当存在同时影响处理组和对照组的混杂政策时，可以使用三重差分法：

**模型设定**：
$$
Y_{ijt} = \beta_0 + \beta_1 Treat_i \times Post_t \times Group_j + \text{所有低阶交互项和主效应} + \epsilon_{ijt}
$$

其中$Group_j$表示第二个分组维度（如行业、地区类型等）。

**识别假设**：
要求混杂政策对第二个分组维度的影响相同，即"共同趋势中的共同趋势"。

**应用场景**：
1. 全国性政策但部分群体豁免
2. 多个政策同时实施
3. 存在同时影响处理组和对照组的外部冲击

## 9.5 双重差分法的常见陷阱、批评与最新进展

### 9.5.1 "坏对照组"问题与处理组选择偏误

**坏对照组问题**：
对照组可能受到政策间接影响，或与处理组在政策实施后的趋势不再可比。

**处理组选择偏误**：
处理组的选择可能非随机，与结果变量的趋势相关。解决方法：
1. 使用匹配方法选择对照组
2. 使用合成控制法
3. 检验和处理选择方程

### 9.5.2 政策内生性与预期效应

**政策内生性**：
政策实施可能基于前期趋势（如"Ashenfelter's dip"），导致估计偏误。

**预期效应**：
政策实施前，个体可能基于预期调整行为，导致政策前效应。

**解决方案**：
1. 检验政策前趋势
2. 使用更早的基线期
3. 考虑动态模型

### 9.5.3 最近的方法论争论与反思

#### "双向固定效应"在交错DID中的偏误
Goodman-Bacon（2021）证明，当处理效应异质时，传统双向固定效应估计量是不同"2×2 DID"比较的加权平均，可能产生偏误。

**偏误来源**：
1. 早期处理组vs晚期处理组比较
2. 已处理组vs尚未处理组比较
3. 处理组vs从未处理组比较

#### 动态偏误与静态偏误
de Chaisemartin & d'Haultfoeuille（2020）区分了：
1. 动态偏误：来自处理组内部的比较
2. 静态偏误：来自处理组与对照组的比较

#### 解决方案
1. 使用Sun & Abraham（2021）、Callaway & Sant'Anna（2021）等方法
2. 使用Borusyak et al.（2021）的插补法
3. 使用de Chaisemartin & d'Haultfoeuille（2020）的估计量

### 9.5.4 合成控制法、匹配DID等混合方法

**合成控制法**：
适用于处理组数量极少的情况，通过加权组合对照组单元构造"合成对照组"。

**匹配DID**：
先进行倾向得分匹配或协变量匹配，再进行DID分析，以改善平行趋势假设。

**双重稳健DID**：
结合匹配和回归调整，提高估计的稳健性。

## 9.6 DID的应用实例与Stata/R操作

### 9.6.1 经典案例研究：最低工资对就业的影响（Card and Krueger，1994）

### 9.6.2 中国语境下的典型案例解读（如"四万亿"投资、房产限购政策评估）

### 9.6.3 DID在Stata/R中的实现步骤与代码示例（`reghdfe`、`did`、`did2s`等命令）

## 本章总结

双重差分法以其清晰的逻辑和易于实现的特点，成为应用微观计量中最受欢迎的政策评估工具之一。本章系统介绍了DID的基本思想、核心假设、模型设定、统计推断方法以及前沿扩展。

DID的有效性完全依赖于**平行趋势假设**的成立，而这一假设本质上不可直接验证，只能通过事前趋势检验和丰富的稳健性分析来提供支持证据。近年来，针对异质性处理效应和交错DID的讨论推动了该方法论的快速发展，研究者现在有更多工具来处理传统双向固定效应模型可能存在的偏误。

在使用DID时，研究者必须注意：
1. 谨慎选择对照组，避免"坏对照组"问题
2. 正确计算聚类稳健标准误，考虑误差结构
3. 进行充分的平行趋势检验和稳健性分析
4. 对于交错DID设计，考虑使用最新的异质性处理效应估计方法
5. 结合其他方法（如合成控制法、匹配方法）提高估计可信度

通过深入理解DID的假设前提和最新方法论进展，研究者可以更准确地评估政策效应，为实证研究提供可靠的方法基础。

